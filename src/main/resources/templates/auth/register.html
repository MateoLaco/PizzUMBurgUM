<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registro de Cliente - PizzUM & BurgUM</title>
    <style>
        /* ---------- Layout base ---------- */
        body{
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin:0; padding:20px;
            min-height:100vh; background:#2c3e50;
            display:flex; justify-content:center; align-items:center;
            overflow-x:hidden;
        }
        .container{ max-width:500px; width:100%; }
        form{
            background:rgba(255,255,255,0.9);
            padding:30px; border-radius:12px;
            box-shadow:0 4px 12px rgba(0,0,0,0.1);
            width:100%; display:flex; flex-direction:column; gap:16px;
            box-sizing:border-box;
        }
        h2{ margin:0 0 10px; text-align:center; color:#333; }
        label{ font-weight:600; color:#333; display:block; margin-bottom:5px; }
        input,select{
            padding:10px; border-radius:8px; border:1px solid #ccc;
            font-size:1rem; width:100%; box-sizing:border-box;
        }
        .form-row{
            display:flex;
            gap:12px;
            align-items: flex-end;
        }
        .form-group{ flex:1; }
        .combo{
            display:flex;
            border:1px solid #ccc;
            border-radius:8px;
            overflow:hidden;
            background:rgba(255,255,255,0.85);
        }

        .flag-select{
            border:none;
            background:transparent;
            padding:10px;
            border-right:1px solid #ccc;
            cursor:pointer;
            width:120px;
        }
        .tel-input{ border:none; flex:1; padding:10px; outline:none; background:transparent; }
        button{
            padding:12px; border-radius:8px; border:none;
            background:#dc3545; color:#fff; font-weight:600; cursor:pointer; font-size:1rem; margin-top:10px;
        }
        button:hover{ background:#9C2007; }
        .login-link{ text-align:center; margin-top:15px; }
        .login-link a{ color:#2c3e50; text-decoration:none; font-weight:600; }
        .login-link a:hover{ text-decoration:underline; }
        .error{ color:#dc3545; font-size:.9rem; text-align:center; padding:10px; background:#ffe6e6; border-radius:5px; }

        .password-feedback{ font-size:.8rem; margin-top:4px; padding-left:5px; display:none; }
        .password-match{ color:#28a745; }
        .password-mismatch{ color:#dc3545; }
        .password-length{ font-size:.8rem; margin-top:4px; padding-left:5px; }
        .password-valid{ color:#28a745; }
        .password-invalid{ color:#dc3545; }

        /* ----- contenedor ojo ----- */
        .password-container{
            position:relative;
        }
        .toggle-password{
            position:absolute;
            right:10px;
            top:50%;
            transform:translateY(-50%);
            background:none !important;
            border:none;
            cursor:pointer;
            padding:0;
        }
        .toggle-password svg{
            width:22px;
            height:22px;
            stroke:#555;
            transition:stroke .2s;
        }
        .toggle-password:focus{ outline:none; box-shadow:none; }


        .toggle-password:hover,
        .toggle-password:focus,
        .toggle-password:active {
            background:none !important;
            outline:none !important;
            box-shadow:none !important;
        }

        /* ---------- MODAL ---------- */
        .modal-overlay{
            position:fixed; inset:0;
            background-color:rgba(0,0,0,0.5);
            display:none;
            justify-content:center; align-items:center;
            z-index:9999;
            padding:24px;
            box-sizing:border-box;
            overflow:auto;
            flex:none;
        }
        .modal-overlay.is-open{ display:flex; }

        .modal-content{
            background:#fff; border-radius:12px;
            width:clamp(320px, 90vw, 560px);
            margin-inline:auto;
            padding:30px; box-sizing:border-box;
            box-shadow:0 4px 20px rgba(0,0,0,0.25);
            position:relative;
        }
        .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .modal-title{ font-size:1.25rem; font-weight:600; color:#333; margin:0; }
        .close-button{
            background:none; border:none; font-size:1.5rem; cursor:pointer; color:#666; padding:0; margin:0;
        }
        .close-button:hover{ color:#333; }

        .payment-method-button{
            padding:10px; border-radius:8px; border:1px solid #ccc; background:#fff; color:#333;
            text-align:left; cursor:pointer; font-size:1rem; width:100%; box-sizing:border-box; transition:border-color .2s; margin:0;
        }
        .payment-method-button:hover{ border-color:#999; }
        .hidden-input{ display:none; }

        #savePaymentMethod{
            background:#dc3545; color:#fff; font-weight:600; cursor:pointer; font-size:1rem;
            padding:12px; border-radius:8px; border:none; width:100%; margin-top:10px;
        }
        #savePaymentMethod:hover{ background:#9C2007; }

        body.modal-open{ overflow:hidden; }


        .birthdate-section {
            margin-bottom: 10px;
        }
        .birthdate-section .birthdate-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }
        .birthdate-fields {
            display: flex;
            gap: 12px;
        }
        .birthdate-field {
            flex: 1;
        }
        .birthdate-field select {
            width: 100%;
        }
        .birthdate-field label {
            font-weight: normal;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: #666;
        }
    </style>
</head>
<body>
<div class="container">
    <form method="POST" action="/auth/register" id="registerForm">
        <h2>Registro de Cliente</h2>

        <div th:if="${error}" class="error" th:text="${error}"></div>

        <div>
            <label for="nombreUsuario">Nombre de Usuario</label>
            <input id="nombreUsuario" name="nombreUsuario" type="text" required />
        </div>

        <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required />
        </div>

        <div>
            <label for="contrasena">Contraseña</label>
            <div class="password-container">
                <input id="contrasena" name="contrasena" type="password" required />
                <button type="button" class="toggle-password" id="toggleContrasena" aria-label="Mostrar u ocultar contraseña">
                    <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M4.5 4.5l15 15M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/>
                    </svg>
                </button>
            </div>
            <div id="passwordLengthMessage" class="password-length">La contraseña debe tener al menos 8 caracteres</div>
        </div>

        <div>
            <label for="confirmarContrasena">Confirmar Contraseña</label>
            <div class="password-container">
                <input id="confirmarContrasena" name="confirmarContrasena" type="password" required />
                <button type="button" class="toggle-password" id="toggleConfirmar" aria-label="Mostrar u ocultar contraseña">
                    <svg id="eyeIconConfirmar" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M4.5 4.5l15 15M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/>
                    </svg>
                </button>
            </div>

            <div id="passwordMatchMessage" class="password-feedback password-match">Las contraseñas coinciden</div>
            <div id="passwordMismatchMessage" class="password-feedback password-mismatch">Las contraseñas no coinciden</div>
        </div>

        <div>
            <label>Método de Pago</label>
            <div id="paymentMethodButton" class="payment-method-button">
                <span id="paymentMethodText">Seleccionar método de pago</span>
            </div>
        </div>

        <input type="hidden" id="metodoPago" name="metodoPago" required />
        <input type="hidden" id="numeroTarjeta" name="numeroTarjeta" required />
        <input type="hidden" id="nombreTarjeta" name="nombreTarjeta" required />
        <input type="hidden" id="vencimientoTarjeta" name="vencimientoTarjeta" required />
        <input type="hidden" id="cvvTarjeta" name="cvvTarjeta" required />

        <div>
            <label for="direccion">Dirección</label>
            <input id="direccion" name="direccion" type="text" placeholder="Calle, número, ciudad" required />
        </div>

        <!-- Sección de fecha de nacimiento  -->
        <div class="birthdate-section">
            <span class="birthdate-label">Fecha de nacimiento</span>
            <div class="birthdate-fields">
                <div class="birthdate-field">
                    <label for="diaNacimiento">Día</label>
                    <select id="diaNacimiento" name="diaNacimiento" required>
                        <option value="" disabled selected>Día</option>
                    </select>
                </div>
                <div class="birthdate-field">
                    <label for="mesNacimiento">Mes</label>
                    <select id="mesNacimiento" name="mesNacimiento" required>
                        <option value="" disabled selected>Mes</option>
                        <option value="1">Enero</option><option value="2">Febrero</option><option value="3">Marzo</option>
                        <option value="4">Abril</option><option value="5">Mayo</option><option value="6">Junio</option>
                        <option value="7">Julio</option><option value="8">Agosto</option><option value="9">Septiembre</option>
                        <option value="10">Octubre</option><option value="11">Noviembre</option><option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="birthdate-field">
                    <label for="anioNacimiento">Año</label>
                    <select id="anioNacimiento" name="anioNacimiento" required>
                        <option value="" disabled selected>Año</option>
                    </select>
                </div>
            </div>
        </div>

        <div>
            <label for="tel">Teléfono</label>
            <div class="combo">
                <select class="flag-select" id="codigoPais" name="codigoPais">
                    <option value="+34">ES +34</option>
                    <option value="+1">US +1</option>
                    <option value="+52">MX +52</option>
                    <option value="+54">AR +54</option>
                    <option value="+56">CL +56</option>
                    <option value="+57">CO +57</option>
                    <option value="+598">UY +598</option>
                </select>
                <input id="tel" name="tel" class="tel-input" type="text" placeholder="9 dígitos" required />
            </div>
        </div>

        <button type="submit" id="submitButton">Crear cuenta</button>

        <div class="login-link">
            <p>¿Ya tienes cuenta? <a href="/auth/login">Iniciar Sesión</a></p>
        </div>
    </form>
</div>

<!-- Modal -->
<div id="paymentModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Información de Tarjeta</h3>
            <button class="close-button" type="button" aria-label="Cerrar">&times;</button>
        </div>
        <form id="paymentForm">
            <div>
                <label for="cardType">Tipo de Tarjeta</label>
                <select id="cardType" required>
                    <option value="" disabled selected>Selecciona un tipo de tarjeta</option>
                    <option value="Visa">Visa</option>
                    <option value="MasterCard">MasterCard</option>
                    <option value="American Express">American Express</option>
                </select>
            </div>

            <div>
                <label for="cardName">Nombre en la Tarjeta</label>
                <input id="cardName" type="text" placeholder="Como aparece en la tarjeta" required />
            </div>

            <div>
                <label for="cardNumber">Número de Tarjeta</label>
                <input id="cardNumber" type="text" placeholder="1234 5678 9012 3456" required />
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="cardExpiryMonth">Mes de Vencimiento</label>
                    <select id="cardExpiryMonth" required>
                        <option value="" disabled selected>Mes</option>
                        <option value="01">Enero</option><option value="02">Febrero</option>
                        <option value="03">Marzo</option><option value="04">Abril</option>
                        <option value="05">Mayo</option><option value="06">Junio</option>
                        <option value="07">Julio</option><option value="08">Agosto</option>
                        <option value="09">Septiembre</option><option value="10">Octubre</option>
                        <option value="11">Noviembre</option><option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cardExpiryYear">Año de Vencimiento</label>
                    <select id="cardExpiryYear" required>
                        <option value="" disabled selected>Año</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cardCVV">CVV</label>
                    <input id="cardCVV" type="text" placeholder="123" maxlength="4" required />
                </div>
            </div>

            <button type="button" id="savePaymentMethod">Guardar Método de Pago</button>
        </form>
    </div>
</div>

<script>
    /* ====== Llenado de selects ====== */
    const diaSelect = document.getElementById('diaNacimiento');
    for (let i = 1; i <= 31; i++) { const o = document.createElement('option'); o.value = i; o.textContent = i; diaSelect.appendChild(o); }

    const anioSelect = document.getElementById('anioNacimiento');
    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= 1920; i--) { const o = document.createElement('option'); o.value = i; o.textContent = i; anioSelect.appendChild(o); }

    const cardExpiryYear = document.getElementById('cardExpiryYear');
    for (let i = currentYear; i <= currentYear + 10; i++) { const o = document.createElement('option'); o.value = i; o.textContent = i; cardExpiryYear.appendChild(o); }

    /* ====== Validación de password ====== */
    const contrasenaInput = document.getElementById('contrasena');
    const confirmarContrasenaInput = document.getElementById('confirmarContrasena');
    const passwordMatchMessage = document.getElementById('passwordMatchMessage');
    const passwordMismatchMessage = document.getElementById('passwordMismatchMessage');
    const passwordLengthMessage = document.getElementById('passwordLengthMessage');
    const registerForm = document.getElementById('registerForm');

    function verificarContrasenas(){
        const c1 = contrasenaInput.value;
        const c2 = confirmarContrasenaInput.value;
        if (c1.length >= 8) {
            passwordLengthMessage.textContent = "La contraseña tiene al menos 8 caracteres";
            passwordLengthMessage.className = "password-length password-valid";
        } else {
            passwordLengthMessage.textContent = "La contraseña debe tener al menos 8 caracteres";
            passwordLengthMessage.className = "password-length password-invalid";
        }
        if (!c1 && !c2) {
            passwordMatchMessage.style.display = 'none';
            passwordMismatchMessage.style.display = 'none';
            return;
        }
        if (c1 === c2) {
            passwordMatchMessage.style.display = 'block';
            passwordMismatchMessage.style.display = 'none';
        } else {
            passwordMatchMessage.style.display = 'none';
            passwordMismatchMessage.style.display = 'block';
        }
    }
    contrasenaInput.addEventListener('input', verificarContrasenas);
    confirmarContrasenaInput.addEventListener('input', verificarContrasenas);

    registerForm.addEventListener('submit', function(e){
        if (contrasenaInput.value !== confirmarContrasenaInput.value) { e.preventDefault(); alert('Las contraseñas no coinciden.'); return; }
        if (contrasenaInput.value.length < 8) { e.preventDefault(); alert('La contraseña debe tener al menos 8 caracteres.'); return; }
        if (!document.getElementById('metodoPago').value) { e.preventDefault(); alert('Por favor, selecciona un método de pago.'); return; }
        // TEL: limpiar antes de enviar (solo dígitos, 8 o 9)
        const telInput = document.getElementById('tel');
        const telDigits = (telInput.value || "").replace(/\D/g,'');
        if (!(telDigits.length === 8 || telDigits.length === 9)) {
            e.preventDefault(); alert('El teléfono debe tener 8 o 9 dígitos.'); telInput.focus(); return;
        }
        telInput.value = telDigits; // backend recibe limpio
    });

    /* ====== Toggle de contraseña ====== */
    const toggleContrasena = document.getElementById('toggleContrasena');
    const eyeIcon = document.getElementById('eyeIcon');
    toggleContrasena.addEventListener('click', ()=>{
        const isPassword = contrasenaInput.type === 'password';
        contrasenaInput.type = isPassword ? 'text' : 'password';
        eyeIcon.innerHTML = isPassword
            ? `<path stroke-linecap="round" stroke-linejoin="round" d="M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/><circle cx="12" cy="12" r="3"/>`
            : `<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5l15 15M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/>`;
    });

    const toggleConfirmar = document.getElementById('toggleConfirmar');
    const eyeIconConfirmar = document.getElementById('eyeIconConfirmar');
    toggleConfirmar.addEventListener('click', ()=>{
        const isPassword = confirmarContrasenaInput.type === 'password';
        confirmarContrasenaInput.type = isPassword ? 'text' : 'password';
        eyeIconConfirmar.innerHTML = isPassword
            ? `<path stroke-linecap="round" stroke-linejoin="round" d="M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/><circle cx="12" cy="12" r="3"/>`
            : `<path stroke-linecap="round" stroke-linejoin="round" d="M4.5 4.5l15 15M1.5 12s4.5-7.5 10.5-7.5S22.5 12 22.5 12s-4.5 7.5-10.5 7.5S1.5 12 1.5 12z"/>`;
    });

    /* ====== TEL: solo números + formato 8/9 ====== */
    (function(){
        const telInput = document.getElementById('tel');
        telInput.addEventListener('input', () => {
            // 1) Posición actual del cursor
            const prevPos = telInput.selectionStart || 0;
            const raw = telInput.value;

            // 2) Dígitos antes del cursor
            const digitsBeforeCaret = raw.slice(0, prevPos).replace(/\D/g, '').length;

            // 3) Limpiar dígitos y limitar a 9
            let digits = raw.replace(/\D/g, '').slice(0, 9);

            // 4) Formato según longitud
            let formatted = digits;
            if (digits.length === 8) {
                formatted = digits.replace(/(\d{4})(\d{4})/, '$1 $2');
            } else if (digits.length === 9) {
                formatted = digits.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
            }

            telInput.value = formatted;

            // 5) Recalcular posición del cursor
            let newPos = 0;
            let digitCount = 0;
            while (newPos < formatted.length && digitCount < digitsBeforeCaret) {
                if (/\d/.test(formatted[newPos])) {
                    digitCount++;
                }
                newPos++;
            }

            telInput.setSelectionRange(newPos, newPos);
        });
    })();


    /* ====== Modal de Tarjeta ====== */
    const paymentModal = document.getElementById('paymentModal');
    const paymentMethodButton = document.getElementById('paymentMethodButton');
    const paymentMethodText = document.getElementById('paymentMethodText');
    const closeButton = document.querySelector('.close-button');
    const savePaymentMethodButton = document.getElementById('savePaymentMethod');

    function openModal(){ paymentModal.classList.add('is-open'); document.body.classList.add('modal-open'); }
    function closeModal(){ paymentModal.classList.remove('is-open'); document.body.classList.remove('modal-open'); }

    paymentMethodButton.addEventListener('click', openModal);
    closeButton.addEventListener('click', closeModal);
    window.addEventListener('click', (e)=>{ if(e.target === paymentModal) closeModal(); });
    window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

    /* ====== Formateo y validación de tarjeta ====== */
    const cardTypeEl   = document.getElementById('cardType');
    const cardNameEl   = document.getElementById('cardName');
    const cardNumberEl = document.getElementById('cardNumber');
    const cardMMEl     = document.getElementById('cardExpiryMonth');
    const cardYYEl     = document.getElementById('cardExpiryYear');
    const cardCVVEl    = document.getElementById('cardCVV');

    const hiddenTipo   = document.getElementById('metodoPago');
    const hiddenNombre = document.getElementById('nombreTarjeta');
    const hiddenNumero = document.getElementById('numeroTarjeta');
    const hiddenVence  = document.getElementById('vencimientoTarjeta');
    const hiddenCVV    = document.getElementById('cvvTarjeta');

    const cfgByType = {
        'Visa':          { max: 16, groups: [4,4,4,4], cvv: 3 },
        'MasterCard':    { max: 16, groups: [4,4,4,4], cvv: 3 },
        'American Express': { max: 15, groups: [4,6,5], cvv: 4 }
    };

    function currentCfg(){
        return cfgByType[cardTypeEl.value] || { max: 19, groups: [4,4,4,4,3], cvv: 3 };
    }

    function formatByGroups(digits, groups){
        let out = [], i = 0;
        for (const g of groups) {
            if (i >= digits.length) break;
            out.push(digits.substr(i, g)); i += g;
        }
        if (i < digits.length) out.push(digits.substr(i)); // sobrante
        return out.join(' ');
    }

    function cleanDigits(value, max){ return (value||'').replace(/\D/g,'').slice(0, max); }

    function luhnOk(num) {
        // Luhn para Visa/MC/AmEx
        let sum = 0, dbl = false;
        for (let i = num.length - 1; i >= 0; i--) {
            let n = parseInt(num[i],10);
            if (dbl) { n *= 2; if (n > 9) n -= 9; }
            sum += n; dbl = !dbl;
        }
        return sum % 10 === 0;
    }

    function updateCardPlaceholderAndMax(){
        const cfg = currentCfg();
        cardNumberEl.placeholder = cfg.groups.map(g=>'X'.repeat(g)).join(' ');
        cardNumberEl.maxLength = cfg.max + (cfg.groups.length - 1); // con espacios
        cardCVVEl.maxLength = cfg.cvv;
        cardCVVEl.placeholder = '•'.repeat(cfg.cvv);
    }

    cardTypeEl.addEventListener('change', ()=>{
        updateCardPlaceholderAndMax();
        const cfg = currentCfg();
        const digits = cleanDigits(cardNumberEl.value, cfg.max);
        cardNumberEl.value = formatByGroups(digits, cfg.groups);
        cardCVVEl.value = cleanDigits(cardCVVEl.value, cfg.cvv);
    });

    cardNumberEl.addEventListener('input', () => {
        const cfg = currentCfg();

        // 1) Posición del cursor ANTES de formatear
        const prevPos = cardNumberEl.selectionStart || 0;
        const raw = cardNumberEl.value;

        // 2) Cuántos dígitos había antes del cursor (ignorando espacios)
        const digitsBeforeCaret = raw.slice(0, prevPos).replace(/\D/g, '').length;

        // 3) Limpiar y limitar dígitos
        const digits = cleanDigits(raw, cfg.max);

        // 4) Formatear con grupos (4-4-4-4 o 4-6-5, etc.)
        const formatted = formatByGroups(digits, cfg.groups);
        cardNumberEl.value = formatted;

        // 5) Calcular nueva posición del cursor para que quede
        // justo después del mismo dígito que antes
        let newPos = 0;
        let digitCount = 0;
        while (newPos < formatted.length && digitCount < digitsBeforeCaret) {
            if (/\d/.test(formatted[newPos])) {
                digitCount++;
            }
            newPos++;
        }

        // 6) Volver a colocar el cursor
        cardNumberEl.setSelectionRange(newPos, newPos);
    });


    cardCVVEl.addEventListener('input', ()=>{
        const cfg = currentCfg();
        cardCVVEl.value = cleanDigits(cardCVVEl.value, cfg.cvv);
    });

    document.addEventListener('DOMContentLoaded', updateCardPlaceholderAndMax);

    // Guardar método de pago desde el modal
    savePaymentMethodButton.addEventListener('click', function(){
        const type  = cardTypeEl.value;
        const name  = (cardNameEl.value || '').trim();
        const mm    = cardMMEl.value;
        const yy    = cardYYEl.value;
        const cvv   = cleanDigits(cardCVVEl.value, currentCfg().cvv);
        const numDigits = cleanDigits(cardNumberEl.value, currentCfg().max);

        // Checks básicos
        if (!type || !name || !mm || !yy || !cvv || !numDigits) {
            alert('Por favor, completa todos los campos de la tarjeta.'); return;
        }

        // Longitudes por tipo
        const cfg = currentCfg();
        if (numDigits.length !== cfg.max) {
            alert(`El número de tarjeta debe tener ${cfg.max} dígitos para ${type}.`); return;
        }

        // Luhn
        // if (!luhnOk(numDigits)) { alert('Número de tarjeta inválido (no pasa validación).'); return; }

        // CVV por tipo
        if (cvv.length !== cfg.cvv) { alert(`El CVV debe tener ${cfg.cvv} dígitos para ${type}.`); return; }

        // Vencimiento >= mes actual
        const now = new Date();
        const exp = new Date(parseInt(yy,10), parseInt(mm,10)-1, 1);
        // si el primer día del mes vencido ya es menor al primer día del mes actual, no sirve:
        if (exp.getFullYear() < now.getFullYear() || (exp.getFullYear() === now.getFullYear() && exp.getMonth() < now.getMonth())) {
            alert('La fecha de vencimiento ya pasó.'); return;
        }

        // Completar ocultos (valores LIMPIOS)
        hiddenTipo.value   = type;
        hiddenNombre.value = name.toUpperCase();          // si querés upper-case
        hiddenNumero.value = numDigits;                   // sin espacios
        hiddenVence.value  = `${mm}/${yy}`;               // MM/YYYY
        hiddenCVV.value    = cvv;

        // UI del botón
        paymentMethodText.textContent = `${type} terminada en ${numDigits.slice(-4)}`;

        closeModal();
    });
</script>

</body>
</html>