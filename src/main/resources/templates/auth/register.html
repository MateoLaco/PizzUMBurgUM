<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Registro de Cliente - PizzUM & BurgUM</title>
    <style>
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #2c3e50;
            padding: 20px;
        }
        .container {
            max-width: 500px;
            width: 100%;
        }
        form {
            background: rgba(255,255,255,0.9);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        h2 {
            margin: 0 0 10px 0;
            text-align: center;
            color: #333;
        }
        label {
            font-weight: 600;
            color: #333;
            display: block;
            margin-bottom: 5px;
        }
        input, select {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        .form-row {
            display: flex;
            gap: 15px;
        }
        .form-group {
            flex: 1;
        }
        .combo {
            display: flex;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
            background: rgba(255,255,255,0.85);
        }
        .flag-select {
            border: none;
            background: transparent;
            padding: 10px;
            border-right: 1px solid #ccc;
            cursor: pointer;
            width: 80px;
        }
        .tel-input {
            border: none;
            flex: 1;
            padding: 10px;
            outline: none;
            background: transparent;
        }
        button {
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #dc3545;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 10px;
        }
        button:hover { background: #9C2007; }
        .login-link {
            text-align: center;
            margin-top: 15px;
        }
        .login-link a {
            color: #2c3e50;
            text-decoration: none;
            font-weight: 600;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        .error {
            color: #dc3545;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            background: #ffe6e6;
            border-radius: 5px;
        }
        .password-feedback {
            font-size: 0.8rem;
            margin-top: 4px;
            padding-left: 5px;
            display: none;
        }
        .password-match {
            color: #28a745;
        }
        .password-mismatch {
            color: #dc3545;
        }
        .is-invalid { border-color: #dc3545 !important; box-shadow: 0 0 0 2px rgba(220,53,69,.15); }
        .field-error { color: #dc3545; font-size: .85rem; }
    </style>
</head>
<body>
<div class="container">
    <form method="POST" action="/auth/register" id="registerForm" th:object="${form}">
        <h2>Registro de Cliente</h2>

        <!-- Mensaje global -->
        <div th:if="${error}" class="error" th:text="${error}"></div>

        <div>
            <label for="nombreUsuario">Nombre de Usuario</label>
            <input id="nombreUsuario" type="text" th:field="*{nombreUsuario}"
                   th:classappend="${#fields.hasErrors('nombreUsuario')}? 'is-invalid' : ''" required />
            <small class="field-error" th:if="${#fields.hasErrors('nombreUsuario')}" th:errors="*{nombreUsuario}"></small>
        </div>

        <div>
            <label for="email">Email</label>
            <input id="email" type="email" th:field="*{email}"
                   th:classappend="${#fields.hasErrors('email')}? 'is-invalid' : ''" required />
            <small class="field-error" th:if="${#fields.hasErrors('email')}" th:errors="*{email}"></small>
        </div>

        <div>
            <label for="contrasena">Contraseña</label>
            <input id="contrasena" type="password" th:field="*{contrasena}"
                   th:classappend="${#fields.hasErrors('contrasena')}? 'is-invalid' : ''" required />
            <small class="field-error" th:if="${#fields.hasErrors('contrasena')}" th:errors="*{contrasena}"></small>
        </div>

        <div>
            <label for="confirmarContrasena">Confirmar Contraseña</label>
            <input id="confirmarContrasena" type="password" th:field="*{confirmarContrasena}"
                   th:classappend="${#fields.hasErrors('confirmarContrasena')}? 'is-invalid' : ''" required />
            <div id="passwordMatchMessage" class="password-feedback password-match">✓ Las contraseñas coinciden</div>
            <div id="passwordMismatchMessage" class="password-feedback password-mismatch">✗ Las contraseñas no coinciden</div>
            <small class="field-error" th:if="${#fields.hasErrors('confirmarContrasena')}" th:errors="*{confirmarContrasena}"></small>
        </div>

        <div>
            <label for="metodoPago">Método de Pago</label>
            <select id="metodoPago" th:field="*{metodoPago}"
                    th:classappend="${#fields.hasErrors('metodoPago')}? 'is-invalid' : ''" required>
                <option value="" disabled>Selecciona un tipo de tarjeta</option>
                <option value="Visa">Visa</option>
                <option value="MasterCard">MasterCard</option>
                <option value="American Express">American Express</option>
            </select>
            <small class="field-error" th:if="${#fields.hasErrors('metodoPago')}" th:errors="*{metodoPago}"></small>
        </div>

        <div>
            <label for="numeroTarjeta">Número de Tarjeta</label>
            <input id="numeroTarjeta" th:field="*{numeroTarjeta}" placeholder="1234 5678 9012 3456"
                   th:classappend="${#fields.hasErrors('numeroTarjeta')}? 'is-invalid' : ''" required />
            <small class="field-error" th:if="${#fields.hasErrors('numeroTarjeta')}" th:errors="*{numeroTarjeta}"></small>
        </div>

        <div>
            <label for="direccion">Dirección</label>
            <input id="direccion" th:field="*{direccion}" placeholder="Calle, número, ciudad"
                   th:classappend="${#fields.hasErrors('direccion')}? 'is-invalid' : ''" required />
            <small class="field-error" th:if="${#fields.hasErrors('direccion')}" th:errors="*{direccion}"></small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="diaNacimiento">Día de nacimiento</label>
                <select id="diaNacimiento" th:field="*{diaNacimiento}"
                        th:classappend="${#fields.hasErrors('diaNacimiento')}? 'is-invalid' : ''" required>
                    <option value="" disabled>Dia</option>
                    <option th:each="d : ${#numbers.sequence(1,31)}" th:value="${d}" th:text="${d}"></option>
                </select>
                <small class="field-error" th:if="${#fields.hasErrors('diaNacimiento')}" th:errors="*{diaNacimiento}"></small>
            </div>
            <div class="form-group">
                <label for="mesNacimiento">Mes de nacimiento</label>
                <select id="mesNacimiento" th:field="*{mesNacimiento}"
                        th:classappend="${#fields.hasErrors('mesNacimiento')}? 'is-invalid' : ''" required>
                    <option value="" disabled>Mes</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                </select>
                <small class="field-error" th:if="${#fields.hasErrors('mesNacimiento')}" th:errors="*{mesNacimiento}"></small>
            </div>
            <div class="form-group">
                <label for="anioNacimiento">Año de Nacimiento</label>
                <select id="anioNacimiento" th:field="*{anioNacimiento}"
                        th:classappend="${#fields.hasErrors('anioNacimiento')}? 'is-invalid' : ''" required>
                    <option value="" disabled>Año</option>
                    <option th:each="y : ${#numbers.sequence(T(java.time.Year).now().getValue(),1920)}"
                            th:value="${y}" th:text="${y}"></option>
                </select>
                <small class="field-error" th:if="${#fields.hasErrors('anioNacimiento')}" th:errors="*{anioNacimiento}"></small>
            </div>
        </div>

        <div>
            <label for="tel">Teléfono</label>
            <div class="combo" th:classappend="${#fields.hasErrors('tel')}? 'is-invalid' : ''">
                <select class="flag-select" id="codigoPais" th:field="*{codigoPais}">
                    <option value="+34">ES +34</option>
                    <option value="+1">US +1</option>
                    <option value="+52">MX +52</option>
                    <option value="+54">AR +54</option>
                    <option value="+56">CL +56</option>
                    <option value="+57">CO +57</option>
                    <option value="+598">UY +598</option>
                </select>
                <input id="tel"
                       class="tel-input"
                       inputmode="numeric"
                       th:field="*{tel}"
                       placeholder="9 dígitos"
                       required />
            </div>
            <small class="field-error"
                   th:if="${#fields.hasErrors('tel')}" th:errors="*{tel}"></small>
        </div>

        <button type="submit" id="submitButton">Crear cuenta</button>

        <div class="login-link">
            <p>¿Ya tienes cuenta? <a href="/auth/login">Iniciar Sesión</a></p>
        </div>
    </form>
</div>

<script>
    // Llenar días del 1 al 31
    const diaSelect = document.getElementById('diaNacimiento');
    for (let i = 1; i <= 31; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        diaSelect.appendChild(option);
    }

    // Llenar años desde 1920 hasta el año actual
    const anioSelect = document.getElementById('anioNacimiento');
    const currentYear = new Date().getFullYear();
    for (let i = currentYear; i >= 1920; i--) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        anioSelect.appendChild(option);
    }

    // Verificar si las contraseñas coinciden
    const contrasenaInput = document.getElementById('contrasena');
    const confirmarContrasenaInput = document.getElementById('confirmarContrasena');
    const passwordMatchMessage = document.getElementById('passwordMatchMessage');
    const passwordMismatchMessage = document.getElementById('passwordMismatchMessage');
    const submitButton = document.getElementById('submitButton');
    const registerForm = document.getElementById('registerForm');

    function verificarContrasenas() {
        const contrasena = contrasenaInput.value;
        const confirmarContrasena = confirmarContrasenaInput.value;

        // Ocultar ambos mensajes si ambos campos están vacíos
        if (contrasena === '' && confirmarContrasena === '') {
            passwordMatchMessage.style.display = 'none';
            passwordMismatchMessage.style.display = 'none';
            return;
        }

        // Mostrar mensaje de coincidencia o no coincidencia
        if (contrasena === confirmarContrasena && contrasena !== '') {
            passwordMatchMessage.style.display = 'block';
            passwordMismatchMessage.style.display = 'none';
        } else {
            passwordMatchMessage.style.display = 'none';
            passwordMismatchMessage.style.display = 'block';
        }
    }

    // Limpiar TEL antes de enviar y chequear longitud 8/9
    registerForm.addEventListener('submit', function(event) {
        // ... tu validación de contraseñas aquí ...

        // Teléfono: dejar solo dígitos
        const telDigits = telInput.value.replace(/\D/g, '');

        // Validar longitud 8 o 9
        if (!(telDigits.length === 8 || telDigits.length === 9)) {
            event.preventDefault();
            alert('El teléfono debe tener 8 o 9 dígitos numéricos.');
            telInput.focus();
            return;
        }

        // Enviar al backend solo dígitos
        telInput.value = telDigits;
    });

    // Agregar event listeners para verificar las contraseñas en tiempo real
    contrasenaInput.addEventListener('input', verificarContrasenas);
    confirmarContrasenaInput.addEventListener('input', verificarContrasenas);

    // Prevenir envío del formulario si las contraseñas no coinciden
    registerForm.addEventListener('submit', function(event) {
        const contrasena = contrasenaInput.value;
        const confirmarContrasena = confirmarContrasenaInput.value;

        if (contrasena !== confirmarContrasena) {
            event.preventDefault();
            alert('Las contraseñas no coinciden. Por favor, verifica que ambas contraseñas sean iguales.');
            confirmarContrasenaInput.focus();
        }
    });

    // Poner foco en el primer campo inválido si existe
    window.addEventListener('DOMContentLoaded', () => {
        const firstInvalid = document.querySelector('.is-invalid');
        if (firstInvalid) firstInvalid.focus();
    });

    const telInput = document.getElementById('tel');

    telInput.addEventListener('input', () => {
        // 1️⃣ Eliminar todo lo que no sea dígito
        let digits = telInput.value.replace(/\D/g, '');

        // 2️⃣ Limitar a 9 dígitos como máximo
        digits = digits.slice(0, 9);

        // 3️⃣ Aplicar formato
        let formatted = digits;
        if (digits.length === 8) {
            // Si tiene 8 dígitos → separar en mitad (4 + 4)
            formatted = digits.replace(/(\d{4})(\d{4})/, '$1 $2');
        } else if (digits.length === 9) {
            // Si tiene 9 dígitos → separar en tres grupos (3 + 3 + 3)
            formatted = digits.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
        }

        // 4️⃣ Actualizar el campo
        telInput.value = formatted;
    });

    (function() {
        const select = document.getElementById('metodoPago');
        const cardInput = document.getElementById('numeroTarjeta');
        const form = document.getElementById('registerForm') || document.querySelector('form');

        // Config por tipo
        const config = {
            'Visa': { maxDigits: 16, groups: [4,4,4,4] },
            'MasterCard': { maxDigits: 16, groups: [4,4,4,4] },
            'American Express': { maxDigits: 15, groups: [4,6,5] }
        };

        // Devuelve configuración actual (o un fallback)
        function currentConfig() {
            const metodo = select.value;
            return config[metodo] || { maxDigits: 19, groups: [4,4,4,4,3] }; // fallback genérico
        }

        // Formatea digits según grupos (array de tamaños)
        function formatByGroups(digits, groups) {
            let out = [];
            let i = 0;
            for (const g of groups) {
                if (i >= digits.length) break;
                out.push(digits.substr(i, g));
                i += g;
            }
            // si quedaron dígitos extras (cuando no coinciden exactamente con suma de groups)
            if (i < digits.length) out.push(digits.substr(i));
            return out.join(' ');
        }

        // Actualiza placeholder y maxlength visible (estimado con espacios)
        function updatePlaceholderAndMax() {
            const cfg = currentConfig();
            // placeholder: genera algo acorde a los grupos
            const ph = cfg.groups.map(g => 'X'.repeat(g)).join(' ');
            cardInput.placeholder = ph;
            // longitud máxima visible: sum digits + number of spaces
            const maxVisible = cfg.maxDigits + (cfg.groups.length - 1);
            cardInput.maxLength = maxVisible;
        }

        // Limpia no-dígitos y limita largo
        function cleanDigits(value, maxDigits) {
            const digits = value.replace(/\D/g, '').slice(0, maxDigits);
            return digits;
        }

        // Evento principal: cuando el usuario escribe
        cardInput.addEventListener('input', () => {
            const cfg = currentConfig();
            let digits = cleanDigits(cardInput.value, cfg.maxDigits);
            // Formatear solo si hay suficiente info o para mejorar UX
            const formatted = formatByGroups(digits, cfg.groups);
            cardInput.value = formatted;
        });

        // Si cambian el método de pago, reformatemos el valor actual
        select.addEventListener('change', () => {
            updatePlaceholderAndMax();
            const cfg = currentConfig();
            const digits = cleanDigits(cardInput.value, cfg.maxDigits);
            cardInput.value = formatByGroups(digits, cfg.groups);
        });

        // Al cargar la página, sincronizar placeholder/max
        document.addEventListener('DOMContentLoaded', updatePlaceholderAndMax);

        // Antes de enviar: validamos longitud y convertimos el valor a solo dígitos
        if (form) {
            form.addEventListener('submit', (ev) => {
                const cfg = currentConfig();
                const digits = cleanDigits(cardInput.value, cfg.maxDigits);

                // Validación: ¿tiene la longitud que corresponde?
                if (digits.length !== cfg.maxDigits) {
                    ev.preventDefault();
                    // Mensaje de error simple; podés integrarlo con BindingResult si querés.
                    alert(`Número de tarjeta inválido. Debe tener ${cfg.maxDigits} dígitos para ${select.value}.`);
                    cardInput.focus();
                    return;
                }

                // SUSTITUIR el valor del campo por solo dígitos (así lo recibe el backend)
                cardInput.value = digits;
                // Si preferís mantener el input visible con formato y enviar otro campo, en vez de
                // reemplazar el value acá podrías crear un input hidden y setear su value = digits.
            });
        }
    })();
</script>
</body>
</html>