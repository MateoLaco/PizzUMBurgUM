<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">

<head>
    <title>Gesti칩n de Pedidos - Admin - PizzUM & BurgUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color:#dc3545; --secondary-color:#ffc107; --dark-color:#2c3e50; --light-color:#f8f9fa; }
        body { font-family:'Poppins',sans-serif; background:var(--dark-color); min-height:100vh; margin:0; }

        .navbar-horizontal{ background:var(--dark-color); padding:1rem 0; box-shadow:0 4px 20px rgba(0,0,0,.1); position:sticky; top:0; z-index:1000;}
        .nav-container{ display:flex; align-items:center; justify-content:space-between; width:100%;}
        .navbar-brand{ font-family:'Montserrat',sans-serif;margin-left: 2rem; font-weight:700; font-size:1.8rem; color:#fff!important; text-decoration:none; white-space:nowrap;}
        .nav-links{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap;}
        .nav-link{ color:#fff!important; font-weight:500; padding:10px 20px!important; border-radius:25px; transition:all .3s ease; text-decoration:none; white-space:nowrap; border:none; background:transparent; cursor:pointer; font-family:inherit; font-size:inherit;}
        .nav-link:hover{ background:rgba(255,255,255,.1); transform:translateY(-2px);}
        .nav-link.active{ background:var(--primary-color); color:#fff!important;}
        .logout-btn{ background:transparent; border:2px solid #fff; color:#fff; padding:8px 20px; border-radius:25px; transition:.3s; white-space:nowrap; cursor:pointer; font-family:inherit;}
        .logout-btn:hover{ background:#fff; color:var(--dark-color);}

        .hero-section{ background:linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.6)), url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&auto=format&fit=crop'); background-size:cover; background-position:center; color:#fff; padding:100px 0 70px; text-align:center;}
        .hero-title{ font-family:'Montserrat',sans-serif; font-weight:700; font-size:2.6rem; margin-bottom:0.5rem; text-shadow:2px 2px 8px rgba(0,0,0,.5);}
        .hero-subtitle{ font-size:1.1rem; font-weight:300; max-width:650px; margin:0 auto;}

        .page-section{ background:#f8f9fa; padding:50px 0 70px;}
        .card-table{ background:#fff; border-radius:16px; box-shadow:0 10px 25px rgba(0,0,0,.08); overflow:hidden;}
        .card-header{ background:#fff; padding:16px 22px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}
        .card-header h3{ margin:0; font-size:1.3rem; font-weight:700; color:var(--dark-color);}

        .filters{ display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
        .filters select,
        .filters input[type="date"]{ padding:8px 12px; border-radius:10px; border:1px solid #ddd; font-size:.95rem; }
        .filters button{ padding:9px 16px; border:none; border-radius:10px; background:var(--dark-color); color:#fff; cursor:pointer; font-weight:600; font-size:.95rem;}
        .filters button:hover{ background:var(--primary-color);}

        .table-responsive{ width:100%; overflow-x:auto;}
        table{ width:100%; border-collapse:collapse; }
        th,td{ padding:12px 14px; border-bottom:1px solid #f0f0f0; font-size:.95rem; vertical-align:middle;}
        th{ background:#fafafa; text-align:left; font-weight:700; color:#444;}

        .status-badge{ padding:6px 10px; border-radius:14px; font-size:.85rem; font-weight:600; display:inline-block;}
        .status-EN_COLA{ background:#fff3cd; color:#856404;}
        .status-EN_PREPARACION{ background:#cce5ff; color:#004085;}
        .status-EN_CAMINO{ background:#d4edda; color:#155724;}
        .status-ENTREGADO{ background:#e2e3e5; color:#383d41;}

        .btn-small{ padding:8px 14px; border-radius:10px; font-size:.85rem; border:none; cursor:pointer; font-weight:600;}
        .btn-primary-small{ background:linear-gradient(45deg,#dc3545,#c82333); color:#fff;}
        .btn-primary-small:hover{ transform:translateY(-1px); box-shadow:0 6px 16px rgba(220,53,69,.3);}

        .alert{ border-radius:10px; padding:10px 14px; font-size:.9rem; margin-bottom:15px;}
        .alert-success{ background:#d4edda; color:#155724; border:1px solid #c3e6cb;}
        .alert-danger{ background:#f8d7da; color:#721c24; border:1px solid #f5c6cb;}

        .footer{ background:var(--dark-color); color:#fff; padding:30px 0; text-align:center; margin-top:30px;}

        @media (max-width:768px){
            .hero-title{ font-size:2rem;}
        }
        .confirm-modal{
            display:none;
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.5);
            justify-content:center;
            align-items:center;
            z-index:2000;
        }
        .confirm-modal.show{
            display:flex;
        }
        .confirm-modal-content{
            background:#fff;
            padding:20px 24px;
            border-radius:14px;
            box-shadow:0 8px 20px rgba(0,0,0,.3);
            max-width:320px;
            width:90%;
            text-align:center;
            font-size:.95rem;
        }
        .confirm-buttons{
            margin-top:16px;
            display:flex;
            justify-content:space-between;
            gap:10px;
        }
        #confirmYes, #confirmNo{
            flex:1;
            padding:8px 10px;
            border-radius:10px;
            border:none;
            cursor:pointer;
            font-weight:600;
            font-size:.9rem;
        }
        #confirmYes{
            background:linear-gradient(45deg,#dc3545,#c82333);
            color:#fff;
        }
        #confirmNo{
            background:#e2e3e5;
            color:#333;
        }
        #confirmYes:hover{
            transform:translateY(-1px);
            box-shadow:0 6px 16px rgba(220,53,69,.3);
        }

    </style>
</head>

<body>
<div layout:fragment="content">

    <!-- NAVBAR ADMIN -->
    <nav class="navbar-horizontal">
        <div class="container">
            <div class="nav-container">
                <a class="navbar-brand" href="/admin/panel">PizzUM & <span>BurgUM</span></a>
                <div class="nav-links">
                    <a class="nav-link" href="/admin/panel">Inicio</a>
                    <a class="nav-link" href="/admin/productos">Productos</a>
                    <a class="nav-link active" href="/admin/pedidos">Pedidos</a>
                    <a class="nav-link" href="/admin/usuarios">Usuarios</a>
                    <a class="nav-link" href="/admin/perfil">Perfil</a>
                    <a th:href="@{/auth/logout}" class="nav-link logout-btn">Salir</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- HERO -->
    <section class="hero-section">
        <div class="container">
            <h1 class="hero-title">Gesti칩n de Pedidos</h1>
            <p class="hero-subtitle">
                Filtra pedidos por estado y fecha, y actualiza su estado operativo:
                <strong>EN_COLA</strong>, <strong>EN_PREPARACION</strong>, <strong>EN_CAMINO</strong>, <strong>ENTREGADO</strong>.
            </p>
        </div>
    </section>

    <!-- CONTENIDO PRINCIPAL -->
    <section class="page-section">
        <div class="container">

            <!-- Mensajes flash -->
            <div th:if="${mensajeExito}" class="alert alert-success" th:text="${mensajeExito}"></div>
            <div th:if="${mensajeError}" class="alert alert-danger" th:text="${mensajeError}"></div>

            <div class="card-table">
                <div class="card-header">
                    <h3>Pedidos</h3>
                    <form th:action="@{/admin/pedidos}" method="get" class="filters">
                        <select name="estado">
                            <option value="">Todos los estados</option>
                            <option value="EN_COLA"
                                    th:selected="${estadoSeleccionado == 'EN_COLA'}">En cola</option>
                            <option value="EN_PREPARACION"
                                    th:selected="${estadoSeleccionado == 'EN_PREPARACION'}">En preparaci칩n</option>
                            <option value="EN_CAMINO"
                                    th:selected="${estadoSeleccionado == 'EN_CAMINO'}">En camino</option>
                            <option value="ENTREGADO"
                                    th:selected="${estadoSeleccionado == 'ENTREGADO'}">Entregado</option>
                        </select>

                        <input type="date"
                               name="fecha"
                               th:value="${fechaSeleccionada}">

                        <button type="submit">Filtrar</button>
                    </form>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                        <tr>
                            <th># Pedido</th>
                            <th>Fecha</th>
                            <th>Acompa침amiento</th>
                            <th>Bebida</th>
                            <th>Costo env칤o</th>
                            <th>Cant. creaciones</th>
                            <th>Estado</th>
                            <th>Cambiar estado</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="p : ${pedidos}">
                            <td th:text="${p.idPedido}">1</td>
                            <td th:text="${p.fecha}">2025-11-01</td>
                            <td th:text="${p.acompanamiento}">Papas fritas</td>
                            <td th:text="${p.bebida}">Refresco</td>
                            <td th:text="${p.costoEnvio != null ? p.costoEnvio : 0}">120</td>
                            <td th:text="${#lists.size(p.creaciones)}">2</td>

                            <td>
                                <span class="status-badge"
                                      th:classappend="${' status-' + p.estado}"
                                      th:text="${p.estado}">
                                    EN_COLA
                                </span>
                            </td>

                            <td>
                                <form th:action="@{/admin/pedidos/{id}/estado(id=${p.idPedido})}"
                                      method="post"
                                      class="form-cambiar-estado">
                                    <select name="estado">
                                        <option value="EN_COLA" th:selected="${p.estado == 'EN_COLA'}">En cola</option>
                                        <option value="EN_PREPARACION" th:selected="${p.estado == 'EN_PREPARACION'}">En preparaci칩n</option>
                                        <option value="EN_CAMINO" th:selected="${p.estado == 'EN_CAMINO'}">En camino</option>
                                        <option value="ENTREGADO" th:selected="${p.estado == 'ENTREGADO'}">Entregado</option>
                                    </select>
                                    <button type="submit" class="btn-small btn-primary-small" style="margin-left:6px;">
                                        Actualizar
                                    </button>
                                </form>
                            </td>
                        </tr>

                        <tr th:if="${#lists.isEmpty(pedidos)}">
                            <td colspan="8" style="text-align:center; padding:20px;">
                                No se encontraron pedidos para los filtros seleccionados.
                            </td>
                        </tr>

                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </section>

    <!-- MODAL DE CONFIRMACI칍N -->
    <div id="confirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <p id="confirmText">쮺onfirmar cambio de estado?</p>
            <div class="confirm-buttons">
                <button type="button" id="confirmYes">S칤, cambiar</button>
                <button type="button" id="confirmNo">Cancelar</button>
            </div>
        </div>
    </div>


    <!-- FOOTER -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 PizzUM & BurgUM. Todos los derechos reservados.</p>
            <p class="mb-0">Backoffice construido para que todo llegue caliente y a tiempo 游댠</p>
        </div>
    </footer>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('active');
            }
        });

        // --- L칍GICA DEL MODAL ---
        const modal = document.getElementById('confirmModal');
        const confirmText = document.getElementById('confirmText');
        const btnYes = document.getElementById('confirmYes');
        const btnNo = document.getElementById('confirmNo');
        let formPendiente = null;

        document.querySelectorAll('.form-cambiar-estado').forEach(form => {
            form.addEventListener('submit', function(e) {
                e.preventDefault(); // no enviar todav칤a
                const select = this.querySelector('select[name="estado"]');
                const nuevo = select ? select.value : '';
                formPendiente = this;
                confirmText.textContent = '쮺onfirmar cambio de estado a "' + nuevo + '"?';
                modal.classList.add('show');
            });
        });

        btnYes.addEventListener('click', function() {
            if (formPendiente) {
                formPendiente.submit(); // ahora s칤 se env칤a al servidor
            }
            modal.classList.remove('show');
            formPendiente = null;
        });

        btnNo.addEventListener('click', function() {
            modal.classList.remove('show');
            formPendiente = null;
        });
    });
</script>



</body>
</html>
